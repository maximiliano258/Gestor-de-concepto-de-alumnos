<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Concepto de Alumnos por Curso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .modal {
            display: none; position: fixed; z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #ffffff; margin: 10% auto; padding: 24px;
            border-radius: 0.75rem; width: 90%; max-width: 450px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); background-color: #2d3748;
            color: white; padding: 12px 24px; border-radius: 0.375rem;
            z-index: 1000; opacity: 0; transition: opacity 0.5s ease-out, bottom 0.5s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .toast.show { opacity: 1; bottom: 30px; }

        /* Custom button styles */
        .btn {
            @apply py-2.5 px-5 rounded-lg shadow-sm text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-150 ease-in-out;
        }
        .btn-primary {
            @apply text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:ring-indigo-500;
        }
        .btn-danger {
            @apply text-white bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .btn-success {
             @apply text-white bg-green-500 hover:bg-green-600 focus:ring-green-400;
        }
        .btn-warning {
            @apply text-white bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400;
        }
        .btn-outline {
            @apply text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-indigo-500;
        }
        .action-btn {
            @apply m-1 text-xs px-2 py-1;
        }
        .course-item {
            @apply flex justify-between items-center w-full text-left p-3 mb-2 rounded-md border border-gray-300 hover:bg-indigo-50 hover:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        .course-item.selected {
            @apply bg-indigo-100 border-indigo-500 font-semibold text-indigo-700;
        }
        .delete-course-btn {
            @apply p-1 text-red-500 hover:text-red-700 focus:outline-none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto max-w-5xl p-4 sm:p-6">
        <!-- Contenedor de Autenticación en la esquina superior derecha -->
        <div id="authContainer" class="absolute top-4 right-4 flex items-center gap-3">
             <!-- Se llenará con JS: Botón de Login o info de usuario + Logout -->
        </div>

        <header class="mb-6 pt-16 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-700">Gestor de Concepto de Alumnos</h1>
            <p id="loadingState" class="text-gray-500 mt-2">Cargando...</p>
        </header>

        <!-- Vista de Login -->
        <div id="loginView" class="text-center mt-12 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Bienvenido</h2>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión con tu cuenta de Google para continuar.</p>
            <button id="loginWithGoogleBtn" class="btn btn-primary inline-flex items-center gap-3">
                <svg class="w-5 h-5" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 65.6l-58.3 55.6C336.7 97.2 295.6 80 248 80c-82.8 0-150.4 67.6-150.4 150.4s67.6 150.4 150.4 150.4c90.8 0 125.3-39.2 129.4-65.4H248V261.8h239.1c.9 12.2 1.8 24.4 1.8 36.8z"></path></svg>
                Iniciar sesión con Google
            </button>
        </div>

        <!-- Vista Principal de la App (oculta hasta el login) -->
        <div id="appView" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Columna de Cursos -->
                <div class="md:col-span-1 bg-white p-5 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-indigo-600 mb-4">Mis Cursos</h2>
                    <div class="mb-4">
                        <input type="text" id="courseNameInput" placeholder="Nombre del Nuevo Curso" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="addCourseBtn" class="btn btn-primary w-full mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Crear Curso
                        </button>
                    </div>
                    <div id="courseList" class="max-h-96 overflow-y-auto">
                        <p id="noCoursesMessage" class="text-gray-500 text-sm">No has creado cursos.</p>
                    </div>
                </div>

                <!-- Columna de Alumnos -->
                <div class="md:col-span-2 bg-white p-5 rounded-xl shadow-lg">
                    <div id="selectedCourseInfo" class="mb-6 text-center">
                        <h2 class="text-xl font-semibold text-indigo-600">Selecciona un curso</h2>
                        <p class="text-gray-500 text-sm">Los alumnos del curso seleccionado aparecerán aquí.</p>
                    </div>

                    <section id="addStudentSection" class="mb-6 p-4 bg-indigo-50 rounded-lg shadow-inner hidden">
                        <h3 class="text-lg font-semibold text-indigo-600 mb-3">Añadir Alumno a <span id="currentCourseNameAddSection" class="font-bold"></span></h3>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="text" id="studentName" placeholder="Nombre del Alumno" class="flex-grow p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="number" id="initialScore" placeholder="Puntaje Inicial" value="5" class="p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:w-32">
                            <button id="addStudentBtn" class="btn btn-primary">Añadir</button>
                        </div>
                    </section>

                    <section id="studentListSection">
                        <div id="studentListContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <p id="noStudentsMessage" class="text-gray-500 col-span-full text-center hidden">No hay alumnos en este curso.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals y Toast -->
    <div id="toastNotification" class="toast"><span id="toastMessage"></span></div>
    <div id="customPointsModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Ajustar Puntos Manualmente</h3>
            <input type="number" id="customPointsInput" step="0.01" placeholder="Ej: 1.5 o -0.75" class="w-full p-2.5 border border-gray-300 rounded-md mb-3">
            <textarea id="customReasonInput" placeholder="Motivo (opcional)" class="w-full p-2.5 border border-gray-300 rounded-md mb-4" rows="2"></textarea>
            <div class="flex justify-end gap-3">
                <button id="cancelCustomPointsBtn" class="btn btn-outline">Cancelar</button>
                <button id="confirmCustomPointsBtn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-2 text-gray-800" id="confirmationTitle">Confirmar Acción</h3>
            <p class="text-sm text-gray-600 mb-6" id="confirmationMessage">¿Estás seguro?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelConfirmationBtn" class="btn btn-outline">Cancelar</button>
                <button id="confirmActionBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // MODIFICADO: Se añaden las funciones de autenticación de Google
        import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, setLogLevel, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INICIO DE LA CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyruonY5rjXaLtgEjuouohhw46KV5Zve4",
            authDomain: "concepto-de-alumnos.firebaseapp.com",
            projectId: "concepto-de-alumnos",
            storageBucket: "concepto-de-alumnos.appspot.com",
            messagingSenderId: "863964895153",
            appId: "1:863964895153:web:a8679164c8f615bd5c4f90"
        };
        const appId = 'concepto-de-alumnos-app';
        // --- FIN DE LA CONFIGURACIÓN DE FIREBASE ---

        let app, auth, db, userId = null;
        let coursesCollectionRef;
        let currentSelectedCourseId = null;
        let currentSelectedCourseName = null;
        let studentsUnsubscribe = null; 

        // UI Elements
        const loadingState = document.getElementById('loadingState');
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const authContainer = document.getElementById('authContainer');
        const loginWithGoogleBtn = document.getElementById('loginWithGoogleBtn');
        
        const courseNameInput = document.getElementById('courseNameInput');
        const addCourseBtn = document.getElementById('addCourseBtn');
        const courseList = document.getElementById('courseList');
        const noCoursesMessage = document.getElementById('noCoursesMessage');
        const selectedCourseInfo = document.getElementById('selectedCourseInfo');
        const addStudentSection = document.getElementById('addStudentSection');
        const currentCourseNameAddSection = document.getElementById('currentCourseNameAddSection');
        const studentNameInput = document.getElementById('studentName');
        const initialScoreInput = document.getElementById('initialScore');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentListContainer = document.getElementById('studentListContainer');
        const noStudentsMessage = document.getElementById('noStudentsMessage');
        const toastNotification = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        const customPointsModal = document.getElementById('customPointsModal');
        const customPointsInput = document.getElementById('customPointsInput');
        const customReasonInput = document.getElementById('customReasonInput');
        const cancelCustomPointsBtn = document.getElementById('cancelCustomPointsBtn');
        const confirmCustomPointsBtn = document.getElementById('confirmCustomPointsBtn');
        let currentStudentIdForCustomPoints = null;
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const cancelConfirmationBtn = document.getElementById('cancelConfirmationBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        let confirmCallback = null;

        // --- Funciones de Utilidad ---
        function showToast(message, duration = 3000) { /* ... */ }
        function openConfirmationModal(title, message, onConfirm) { /* ... */ }
        function closeConfirmationModal() { /* ... */ }
        
        // --- Lógica de Autenticación con Google ---
        const provider = new GoogleAuthProvider();

        async function handleGoogleLogin() {
            try {
                await signInWithPopup(auth, provider);
                // `onAuthStateChanged` se encargará del resto.
            } catch (error) {
                console.error("Error durante el inicio de sesión con Google: ", error);
                showToast("Error al iniciar sesión. Intenta de nuevo.");
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // `onAuthStateChanged` se encargará del resto.
                userId = null;
                courseList.innerHTML = '<p id="noCoursesMessage" class="text-gray-500 text-sm">No has creado cursos.</p>';
                studentListContainer.innerHTML = '';
            } catch (error) {
                console.error("Error al cerrar sesión: ", error);
                showToast("Error al cerrar sesión.");
            }
        }


        // --- Manejo del estado de la UI (Login/Logout) ---
        function showLoginState() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loadingState.classList.add('hidden');
            authContainer.innerHTML = ''; // Limpia el contenedor de auth
        }

        function showAppContent(user) {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            loadingState.classList.add('hidden');
            
            // Muestra la información del usuario y el botón de logout
            authContainer.innerHTML = `
                <span class="text-sm text-gray-700">Hola, ${user.displayName.split(' ')[0]}</span>
                <button id="logoutBtn" class="btn btn-outline text-xs py-1.5 px-3">Cerrar Sesión</button>
            `;
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        }
        

        // --- Inicialización y Lógica Principal ---
        async function initializeFirebaseServices() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario ha iniciado sesión (con Google)
                        userId = user.uid;
                        showAppContent(user);
                        coursesCollectionRef = collection(db, "artifacts", appId, "users", userId, "courses");
                        loadCourses();
                    } else {
                        // Usuario no ha iniciado sesión
                        showLoginState();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase: ", error);
                loadingState.textContent = "Error de Firebase";
                showToast("Error al conectar con Firebase. Revisa la configuración en el HTML y la consola.", 5000);
            }
        }
        
        // Las demás funciones (addCourse, loadCourses, addStudent, etc.) permanecen iguales pero ahora dependen de `userId` de un usuario real.
        
        async function addCourse() { /* ... */ }
        function loadCourses() { /* ... */ }
        function handleCourseSelection(courseId, courseName) { /* ... */ }
        async function addStudent() { /* ... */ }
        function loadStudents(courseId) { /* ... */ }
        function createStudentCard(student, courseId) { /* ... */ }
        function updateHistoryLog(studentId, historyArray) { /* ... */ }
        async function updateStudentScore(courseId, studentId, pointsChange, reason = "Ajuste manual") { /* ... */ }
        function openCustomPointsModal(studentId) { /* ... */ }
        function closeCustomPointsModal() { /* ... */ }
        async function handleConfirmCustomPoints() { /* ... */ }
        async function deleteStudent(courseId, studentId, studentName) { /* ... */ }
        async function deleteCourse(courseId, courseName) { /* ... */ }

        // Event Listeners
        loginWithGoogleBtn.addEventListener('click', handleGoogleLogin);
        addCourseBtn.addEventListener('click', addCourse);
        addStudentB
